## üåê Internationalization (i18n) and Translation Workflow

The QGIS Website project is fully internationalized using [hugo-gettext](https://github.com/PhuNH/hugo-gettext) and [Transifex](https://www.transifex.com/). The translation workflow is fully integrated and automated via CI/CD.

### Quick overview

- Internationalization: Source content in `content/`, translations generated to `content-translated/<lang>/` via hugo-gettext. Transifex hosts strings and translations.
- CI for i18n: Extract ‚Üí push to Transifex ‚Üí pull translations ‚Üí compile ‚Üí generate. See `.github/workflows/i18n.yml`.
- Fallback mounting: For each language, Hugo mounts translated content first and falls back to English automatically (no manual copies).
- Language redirect on non-prefixed URLs: If a URL has no language prefix (e.g., `/`, `/project/overview`), the site may redirect to the same path under the user's language (e.g., `/nl/`, `/nl/project/overview`) when translation coverage meets a threshold. English is never prefixed/redirected.
  - Threshold: `.Site.Params.langRedirectThreshold` (default 80). Configure in `config.toml`.
  - Coverage source: `data/tx_coverage.json`, updated by CI (see below).
  - Debug logs: add `?langredirdebug=1` to the URL.
- Coverage refresh CI: `.github/workflows/tx-coverage.yml` runs `scripts/tx_fetch_coverage.py` (Transifex REST API v3) to update `data/tx_coverage.json` daily.
- Production builds (incremental per language): Build EN, then each language one-by-one and deduplicate media to keep artifacts small. See `scripts/build_prod_per_lang.sh` and `scripts/dedup_public.py` (details in `DEVELOPMENT.md`).

### Folder Structure

- **Original content:**
  - `content/` ‚Äî English (source language) content.
- **Translated content:**
  - `content-translated/de/`, `content-translated/es/`, etc. ‚Äî Translated content for each language, mirroring the structure of `content/`.
- **Translation files:**
  - `translations/en/messages.pot` ‚Äî Extracted source strings (template).
  - `translations/de/messages.po`, `translations/es/messages.po`, etc. ‚Äî Translations for each language.
- **YAML translations:**
  - `i18n/en.yml` ‚Äî Source strings for HTML templates.
  - `i18n/de.yml`, `i18n/es.yml`, etc. ‚Äî Translations for HTML templates.
  - `tx-temp/` ‚Äî Temporary directory for Transifex YAML files.

### Hugo and hugo-gettext Configuration

The configuration example for hugo-gettext is set in `config.toml`:

```toml
[i18n]
  package = "messages"
  genToOtherDir = true
  srcDir = "content"
  genDir = "content-translated"
  excludedKeys = "heroSize heroImage HeroImage heroLogo Badge BadgeLink ..."
  [i18n.shortcodes]
    [i18n.shortcodes.params]
      feature = ["title", "text", "col-title-1", "col-text-1", ...]
      block = ["title", "subtitle"]
      rich-list = ["listTitle", "listSubtitle"]
      # ... other shortcode parameters
  [i18n.content]
    [i18n.content.default]
      files = ["content/_index.md"]
      globs = ["content/**/*.md"]
      excludedGlobs = ["content/community-blogs/**", "content/funders/**", ...]

[languages]
  [languages.en]
    languageCode = "en"
    title = "QGIS"
    weight = 2
  [languages.de]
    languageCode = "de"
    weight = 2
  # ... other languages

[module]
  # English uses original content
  [[module.mounts]]
    source = "content"
    target = "content"
    lang = "en"
  
  # Other languages: translated content first, then English fallback
  [[module.mounts]]
    source = "content-translated/de"
    target = "content"
    lang = "de"
  [[module.mounts]]
    source = "content"
    target = "content"
    lang = "de"
  # ... similar pairs for other languages
```

### Translation Workflow

The translation process is fully automated and consists of the following steps:

1. **String extraction:**
   - On each update, `hugo-gettext extract translations/en/` is run to extract all translatable strings from the source content. The output is saved to `translations/en/messages.pot`.
2. **Transifex integration:**
   - The extracted `.pot` file is automatically pushed to Transifex using the Transifex CLI (`tx push -s`).
   - Translators work on translations in Transifex.
   - Translated `.po` files are regularly pulled from Transifex (`tx pull -a`).
3. **Compilation and generation:**
   - All `.po` files are compiled to `.mo` files with `hugo-gettext compile translations`.
   - Translated content is generated for each language using `hugo-gettext generate`, producing the localized content in `content-translated/<lang>/`.
4. **CI/CD:**
   - All these steps are run automatically in the CI/CD pipeline (see `.github/workflows/i18n.yml`).

### Transifex Configuration

The project includes a preconfigured `.tx/config` with two resources:

```ini
[main]
host = https://app.transifex.com

[o:qgis:p:qgis-website:r:qgis-hugo-docs-md]
file_filter = translations/<lang>/messages.po
source_file = translations/en/messages.pot
source_lang = en
type = PO
resource_name = qgis-hugo-docs-md

[o:qgis:p:qgis-website:r:qgis-hugo-docs-yml]
file_filter = tx-temp/<lang>.yml
source_file = tx-temp/en.yml
source_lang = en
type = YML
resource_name = qgis-hugo-docs-yml
```

The configuration defines two resources:
1. `qgis-hugo-docs-md` - for markdown content translations (PO files)
2. `qgis-hugo-docs-yml` - for YAML translations used in HTML templates

The Transifex API token is stored in the CI/CD environment and in `~/.transifexrc` for local development.

### Translating Shortcode Parameters

When using shortcodes in your content, you need to specify which parameters should be translated. This is done by adding the parameters to the `i18n.shortcodes.params` section in `config.toml`.

For example, if you have a shortcode `my-shortcode` with parameters `title` and `description` that need to be translated, you would add them to the config like this:

```toml
[i18n.shortcodes.params]
  my-shortcode = ["title", "description"]
```

When you add a new shortcode or modify an existing one, make sure to add any translatable parameters to this configuration. This ensures that the parameters will be included in the translation files when you run `hugo i18n --gen`.

### YAML Translations for HTML Templates

For translations used in HTML templates (not in markdown files), we use a different approach:

1. **Translation Keys in HTML:**
   - Use the `{{ i18n "key" }}` function in HTML templates to reference translatable strings
   - Example: `{{ i18n "exploreQgis" }}` in `themes/hugo-bulma-blocks-theme/layouts/partials/explore.html`

2. **YAML Translation Files:**
   - Translations are stored in YAML files in the `i18n/` directory
   - Each language has its own file (e.g., `i18n/en.yml`, `i18n/ru.yml`)
   - Format: `key: "translated text"`

3. **Transifex Integration:**
   - Due to different YAML formats between Hugo and Transifex, we use conversion scripts:
     - `scripts/tx_convert_push.py`: Converts Hugo YAML to Transifex format
     - `scripts/tx_convert_pull.py`: Converts Transifex YAML back to Hugo format

### Working with HTML Template Translations

**Adding new translations:**
1. Add new keys to `i18n/en.yml` with English text
2. Add corresponding translations to language files (e.g., `i18n/ru.yml`, `i18n/de.yml`)
3. Use the key in HTML templates with `{{ i18n "key" }}`

**Example workflow:**
```yaml
# In i18n/en.yml
- id: newButtonText
  translation: "Download Now"

# In i18n/ru.yml  
- id: newButtonText
  translation: "–°–∫–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å"

# In HTML template
<button>{{ i18n "newButtonText" }}</button>
```

**Updating existing translations:**
- Edit YAML files directly in `i18n/` directory
- Or use Transifex workflow: `make txpush` ‚Üí translate in Transifex ‚Üí `make txpull`

**Testing translations:**
- Run `hugo server` to see changes immediately
- Check different languages by visiting `/ru/`, `/de/`, etc.
- Verify translations appear correctly in HTML templates



### Example CI/CD Steps

The following steps are executed automatically:

```yaml
- name: Extract strings
  run: hugo-gettext extract translations/
- name: Push to Transifex
  run: tx push -s
- name: Pull translations
  run: tx pull -a
- name: Compile .po to .mo
  run: hugo-gettext compile translations/
- name: Generate translated content
  run: hugo-gettext generate
```

### Makefile Commands for Translations

The following Makefile commands are available for translation management:

```bash
# Extract translatable strings from content and create/update messages.pot
# This command scans all content files and extracts strings marked for translation
make messages-extract

# Compile .po files to .mo files
# This step is necessary for Hugo to use the translations
make messages-compile

# Generate translated content from .mo files
# Creates translated versions of content in content-translated/<lang>/
make generate-translations

# Clean translated content directory
# Removes all content from content-translated/
make clean-translations

# Push source strings to Transifex
# Converts and uploads English strings to Transifex for translation
make txpush

# Pull translations from Transifex
# Downloads translations from Transifex and converts them to Hugo format
make txpull

# Fix newlines in translation files
# Corrects newline mismatches between msgid and msgstr entries
make fix-newlines

# Create Python virtual environment
# Sets up Python environment needed for translation scripts
make venv
```

These commands are typically used in sequence during the translation workflow:

1. `make venv` - Set up the Python environment
2. `pip install -r requirements.txt` - Install required packages
3. `make messages-extract` - Extract strings for translation
4. `make txpush` - Upload strings to Transifex
5. `make txpull` - Download translations from Transifex
6. `make messages-compile` - Compile translations
7. `make generate-translations` - Generate translated content

The commands are used in the CI/CD pipeline and can also be run locally for development. Translation fallback (displaying English content for untranslated pages) is now handled automatically by Hugo's content mounting system configured in `config.toml`.

**‚ö†Ô∏è Important Note:** The `make generate-translations` command modifies the `config.toml` file in the `[languages]` section. These changes are automatically generated and should be **ignored in git**. If you see changes to `config.toml` after running translation commands, you can safely discard them.

### Translation Fallback Mechanism

Translation fallback is handled automatically by Hugo's content mounting system. For each language, Hugo mounts the translated content directory first, then the original English content as fallback:

```toml
[module]
  # English uses original content
  [[module.mounts]]
    source = "content"
    target = "content"
    lang = "en"
  
  # Other languages: translated content first, then English fallback
  [[module.mounts]]
    source = "content-translated/de"
    target = "content"
    lang = "de"
  [[module.mounts]]
    source = "content"
    target = "content"
    lang = "de"
```

This means when accessing `/de/some-page/`, Hugo first looks in `content-translated/de/some-page.md`. If it doesn't exist, it automatically falls back to `content/some-page.md` (English version). This eliminates the need for manual content copying commands.

### Language redirect based on translation coverage

To improve UX on the root path `/`, the site can automatically redirect users to their preferred language when translation coverage is high enough.

- **Script**: `themes/hugo-bulma-blocks-theme/assets/js/lang-redirect.js` (bundled via the header partial)
- **Coverage data**: `data/tx_coverage.json` (map of language code ‚Üí percent translated)
- **Threshold parameter**: `.Site.Params.langRedirectThreshold` (default: 80)

Behavior:
- Runs only on non-prefixed paths (e.g. `/`), and does nothing if the URL already starts with a language prefix (e.g. `/nl/` or `/ro/`).
- Picks a target language based on `navigator.languages`/`navigator.language` with handling for regional variants (e.g. `zh-Hans`/`zh-Hant`, `pt_BR`/`pt_PT`).
- Never redirects to `en`; English stays at the root by design.
- Redirect happens only if translation coverage for the chosen language is `>= langRedirectThreshold`.
- Debug logging can be enabled with the query parameter `?langredirdebug=1`.

Config example (set threshold to 80):

```toml
[params]
  langRedirectThreshold = 80
```

If the coverage entry for a language is missing, the script treats it as below threshold and does not redirect.

### CI job to update translation coverage

The coverage file `data/tx_coverage.json` is updated automatically from Transifex, and it drives the redirect threshold logic above.

- **Update script**: `scripts/tx_fetch_coverage.py` (uses Transifex REST API v3)
- **Make target**: `make txcoverage` (writes `data/tx_coverage.json`)
- **CI workflow**: `.github/workflows/tx-coverage.yml` (runs daily, commits the updated coverage file)

Notes:
- Requires `TX_TOKEN` (Transifex API token) in the environment/CI secrets. Locally run with:
  - `TX_TOKEN=xxxx make txcoverage`
- The script aggregates coverage for the resource(s) listed in the Makefile target (currently `qgis-hugo-docs-md`) and outputs a simple `{ lang: percent }` JSON.
- The redirect script reads this file at runtime; you can adjust the threshold via `.Site.Params.langRedirectThreshold` to tighten/relax redirect criteria.

### Summary

- The i18n process is fully integrated and automated.
- Source content is in `content/`, translations are in `content-translated/<lang>/`.
- All translation files are managed in `translations/` and synchronized with Transifex.
- No manual steps are required for regular translation updates ‚Äî everything is handled by the pipeline.

### Preventing Hugo-Gettext Errors

To ensure smooth operation of hugo-gettext, follow these important formatting requirements:

1. **Shortcode Formatting**  
   When using shortcodes, the closing tag `>}}` must not be placed on a new line. While the shortcode itself can span multiple lines, the closing tag must be on the same line as the last content.

   **Correct:**
   ```
   {{< figure src="/images/example.jpg"
              title="Example image"
              alt="Description of the image" >}}
   ```

   **Incorrect:**
   ```
   {{< figure src="/images/example.jpg"
              title="Example image"
              alt="Description of the image"
   >}}
   ```

2. **Avoid Hard Line Breaks in Multi-line Shortcodes**  
   In multi-line shortcodes, do not use Markdown hard line breaks (two or more spaces at the end of a line or a backslash \ at the end of a line that create a `<br>` in HTML). These breaks can interfere with hugo-gettext processing.

   **Example of problematic hard line breaks:**
   ```
   {{< block
       title="Sustaining Members."¬∑¬∑
       subtitle="Create a recurring sustaining membership."¬∑¬∑¬∑
       image=""
       sub-block-side="bottom"
       class="is-danger"
       title-size="is-4"
       subtitle-size="is-6"
       link="funding/sustaining-members/"
       link-text="Subscribe!">}}{{< /block >}}
   ```
   *(Note: The `¬∑¬∑` represents two spaces at line end. Similarly, avoid using `\` at the end of lines)*

   Instead, ensure no trailing spaces or backslashes exist at line ends within shortcodes.

3. **Empty Markdown Files**  
   Do not create completely empty markdown files (without any content or front matter) in the `content` directory as they can cause hugo-gettext to break with errors.

4. **Newlines in Translation Strings**  
   Avoid extra newlines (`\n`) at the end of `msgstr` entries if the corresponding `msgid` doesn't have them. This mismatch can cause compilation errors.

   **Example:**
   ```
   msgid "Language"
   msgstr "–ï–∑–∏–∫\n"  # Problematic - has \n while msgid doesn't
   ```

   Should be:
   ```
   msgid "Language"
   msgstr "–ï–∑–∏–∫"  # Correct
   ```

   A fix-newlines script is available to automatically correct these issues:
   ```
   make fix-newlines
   ```

5. **Avoid HTML Comments with Shortcodes**  
   Do not use HTML comments (`<!-- -->`) to comment out shortcodes or markdown content in `.md` files. This can cause issues with hugo-gettext parsing and lead to errors during translation processing.

   **Problematic example:**
   ```html
   <!--
   {{< tab-content-start tab="2" >}}
   Content here...
   {{< tab-content-end >}}
   -->
   ```

   Instead, use Hugo's built-in commenting mechanism or remove the commented code entirely.

6. **Avoid Empty Parameters in Shortcodes**  
   Do not include empty parameters in shortcodes (especially empty string parameters like `param=""`). These can cause issues with hugo-gettext processing.

   **Problematic example:**
   ```
   {{< rich-list listLink="https://qgis.org/api/|ltrversion|/"  layoutClass="inline-block" listTitle="C++ API documentation" listSubtitle="">}}
   ```

   Instead, either completely remove the parameter if it's optional, or provide a meaningful value.

7. **Use Correct Front Matter Delimiters and Syntax**  
   Use only YAML front matter with triple dash delimiters (`---`) for all markdown files. Do not use the triple plus (`+++`) format which is for TOML front matter. Also ensure that the syntax inside follows YAML format (using colons `:` for assignments), not TOML format (which uses equals `=`).

   **Correct YAML format:**
   ```yaml
   ---
   title: "Page Title"
   date: 2023-04-15
   aliases: ["/old-url"]
   tags: ["tag1", "tag2"]
   ---
   ```

   **Incorrect (TOML format with YAML delimiters):**
   ```
   ---
   title = "Page Title"
   date = 2023-04-15
   aliases = ["/old-url"]
   tags = ["tag1", "tag2"]
   ---
   ```

   **Incorrect (TOML format):**
   ```toml
   +++
   title = "Page Title"
   date = 2023-04-15
   +++
   ```

   Using the incorrect front matter format or mixing syntaxes can cause issues with hugo-gettext parsing and lead to translation errors.

8. **Use Single-line Shortcodes in Markdown Tables**  
   When using shortcodes inside Markdown tables, ensure that the shortcodes are written in a single line. Multi-line shortcodes within tables can break hugo-gettext processing.

   **Correct (single-line shortcode in table):**
   ```markdown
   | Column 1 | Column 2 |
   |----------|----------|
   | Content  | {{< my-shortcode param1="value1" param2="value2" >}} |
   ```

   **Incorrect (multi-line shortcode in table):**
   ```markdown
   | Column 1 | Column 2 |
   |----------|----------|
   | Content  | {{< my-shortcode 
                  param1="value1" 
                  param2="value2" >}} |
   ```

   Always consolidate shortcodes to a single line when they are used inside tables.

9. **Do Not Hardcode `url` in Front Matter for Localized Pages**  
   In multilingual sites, setting a custom `url` in front matter bypasses Hugo's language-prefixed routing (e.g., `/nl/...`) and breaks English fallback for missing translations. Let Hugo generate URLs automatically per language. If you need stable redirects, use `aliases` instead of `url`.

   **Incorrect (breaks language prefixes and fallback):**
   ```yaml
   ---
   title: "Download"
   type: "page"
   url: "/download"  # ‚ùå Do not set
   ---
   ```

   **Correct (let Hugo handle language prefixes):**
   ```yaml
   ---
   title: "Download"
   type: "page"
   # no explicit url
   ---
   ```

   If you must preserve an old path, prefer:
   ```yaml
   ---
   title: "Download"
   type: "page"
   aliases: ["/old-download/"]
   ---
   ```


